#! /bin/bash

if [ -f $1 ]; then
    if [ $1 -ot $1.cpp ]; then
        echo phy++: re-compiling \'$1\'...
        RECOMPILE=1
    else
        RECOMPILE=0
        for f in ${PHYPP_PATH}/include/*
        do
            if [ -f $f ] && [ "$f" -nt $1 ]; then
                echo $f is more recent than program, re-compiling \'$1\'...
                RECOMPILE=1
                break
            fi
        done
        if [ $RECOMPILE -eq 0 ]; then
            for f in ${PHYPP_PATH}/lib/*
            do
                if [ -f $f ] && [ "$f" -nt $1 ]; then
                    echo $f is more recent than program, re-compiling \'$1\'...
                    RECOMPILE=1
                    break
                fi
            done
        fi
    fi
else
    echo phy++: compiling \'$1\'...
    RECOMPILE=1
fi

if [ $RECOMPILE -eq 1 ]; then
    T="$(date +%s%N)"

    clang-3.3 $1.cpp -emit-ast -I "$PHYPP_PATH/include" -I "$PHYPP_PATH/lib" \
        -DREFLECTION_STAGE -ferror-limit=5 -std=c++1y -o $1.ast -w
    RETVAL=$?
    if [ $RETVAL -ne 0 ]; then
        echo phy++: program \'$1\' FAILED to compile
        exit
    fi
    refgen $1
    echo phy++: reflection data generated
    rm $1.ast

    clang-3.3 ._reflex_$1.cpp -O3 -ferror-limit=5 -ltcmalloc -lprofiler \
        -I "$PHYPP_PATH/include" -I "$PHYPP_PATH/lib" \
        -std=c++1y -lstdc++ -lcfitsio -lCCfits -lwcs -llapack -lgsl -o $1 \
        -Weverything -Wno-c++98-compat-pedantic -Wno-c++98-compat -Wno-unused-parameter \
        -Wno-sign-conversion -Wno-conversion -Wno-missing-prototypes -Wno-padded -Wno-float-equal \
        -Wno-unused-variable -Wno-global-constructors -Wno-exit-time-destructors

    T="$(($(date +%s%N)-T))"
    S="$((T/1000000000))"
    M="$((T/1000000))"

    RETVAL=$?
    if [ $RETVAL -eq 0 ]; then
        echo phy++: program \'$1\' successfully compiled
        printf "compilation time: %02d:%02d.%03d\n" "$((S/60%60))" "$((S%60))" "${M}"
    else
        echo phy++: program \'$1\' FAILED to compile
        exit
    fi
fi

a=./$1
shift
env CPUPROFILE=$a.prof $a "$@"
pprof --gv $a $a.prof
